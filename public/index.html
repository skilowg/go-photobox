<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello Photobox!</title>

  <style>
    body {
      font-family: Helvetica, sans-serif;
    }
    h1 {
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Hello Photobox</h1>

  <ul id="files">
  </ul>

  <script>
    var req = new XMLHttpRequest(),
        filesListDOM = document.getElementById('files'),
        files, listForPath;

    listForPath = function (path) {
      var oldLinks;
      // Set up request to server for files at `path`
      req.open("GET", "/files" + (path.length ? '?path=' + path : ''));

      req.onreadystatechange = function (evt) {
        var docFrag;
        if (req.readyState === 4) {
          docFrag = document.createDocumentFragment();

          files = req.response.split(',');

          if (files.length === 0) {
            // Bail early if the request was empty!
            return;
          }

          // Clean up after any existing links
          Array.prototype.forEach.call(document.querySelectorAll('#files li'), function (item) {
            if (item.remove) {
              item.remove();
            } else {
              item.parentNode.removeChild(item);
            }
          });

          // Build new links
          files.map(function (f) {
            var item = document.createElement("li"),
                link = document.createElement("a");

            link.textContent = f;
            link.href = "/files?path=" + f;
            // Add new link click listeners
            link.onclick = function (evt) {
              var pathMatch = evt.currentTarget.href.match(/path=(.*)$/);
              if (pathMatch.length > 1) {
                listForPath(pathMatch[1]);
              }

              evt.preventDefault();
              return false;
            };

            item.appendChild(link);
            docFrag.appendChild(item);
          });

          filesListDOM.appendChild(docFrag);
        }
      };

      req.send();
    };

    listForPath('');
  </script>
</body>
</html>
